"use strict";var h=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var q=(t,o)=>{for(var n in o)h(t,n,{get:o[n],enumerable:!0})},U=(t,o,n,e)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of Z(o))!F.call(t,s)&&s!==n&&h(t,s,{get:()=>o[s],enumerable:!(e=X(o,s))||e.enumerable});return t};var A=t=>U(h({},"__esModule",{value:!0}),t);var Q={};q(Q,{onInitialize:()=>V,onShutdown:()=>j});module.exports=A(Q);var C=require("@serenityjs/item"),E=require("@serenityjs/world");var T=require("@serenityjs/protocol"),W=require("quick.db");var m=require("@serenityjs/protocol");function z(t,o){let n=Math.min(t.x,o.x),e=Math.max(t.x,o.x),s=Math.min(t.z,o.z),r=Math.max(t.z,o.z),l=[];for(let a=n;a<=e;a++)for(let g=s;g<=r;g++)l.push(new m.BlockCoordinates(a,0,g));return l}function b(t,o){let n=Math.min(t.x,o.x),e=Math.max(t.x,o.x),s=Math.min(t.z,o.z),r=Math.max(t.z,o.z),l=[];for(let a=n;a<e;a++)l.push(new m.BlockCoordinates(a,0,s)),l.push(new m.BlockCoordinates(a,0,r));l.push(new m.BlockCoordinates(e,0,s)),l.push(new m.BlockCoordinates(e,0,r));for(let a=s;a<r;a++)l.push(new m.BlockCoordinates(n,0,a)),l.push(new m.BlockCoordinates(e,0,a));return l.push(new m.BlockCoordinates(n,0,r)),l.push(new m.BlockCoordinates(e,0,r)),l}var D=require("@serenityjs/block"),I=require("@serenityjs/protocol"),w;(o=>{function t(n,e,s){let r=new I.UpdateBlockPacket;r.position=s,r.networkBlockId=D.BlockPermutation.resolve(e).network,r.flags=0,r.layer=0,r.offset=0,n.session.send(r)}o.clientBlock=t})(w||={});var $=require("@serenityjs/block"),p=new W.QuickDB({table:"PlotManager"}),d;(_=>{let t={},o=0;async function n(){await p.get("plots")||p.set("plots",JSON.stringify({})),await p.get("currentIndex")||p.set("currentIndex",1),o=await p.get("currentIndex"),t=JSON.parse(await p.get("plots"))}_.loadDB=n;async function e(){await p.set("plots",JSON.stringify(t)),await p.set("currentIndex",o+1)}_.unloadDB=e;function s(i){let c=z(i.coordinates[1],i.coordinates[2]);for(let u of c)if(O(u,i.world,i.dimension))return{error:"Cant Create Plot On Existing Plot"};t[o]=i,o=o+1}_.addPlot=s;function r(){return t}_.getAllPlotData=r;function l(i,c){if(!t[i])throw Error(`Plot "${i}" doesnt exists`);t[i]=c}_.setPlot=l;function a(i){return t[i]?t[i]:void 0}_.getPlot=a;function g(i,c){let u=b(i.coordinates[1],i.coordinates[2]),B=[];if(c.getWorld().identifier!=i.world)throw Error("Player Must Be In The Same World As This Plot");if(c.dimension.identifier!=i.dimension)throw Error("Player Must Be In The Same Dimension As This Plot");let x=c.dimension;for(let f of u){let k=new T.BlockCoordinates(f.x,c.dimension.getTopmostBlock({x:f.x,z:f.z,y:400}).position.y,f.z);B.push(x.getBlock(f)),w.clientBlock(c,$.BlockIdentifier.Glowstone,k)}setTimeout(()=>{for(let f of u){let k=B[u.indexOf(f)];w.clientBlock(c,k.getType().identifier,k.position)}},5e3)}_.labelPlot=g;function O(i,c,u){for(let B of Object.keys(t)){let x=t[Number(B)];if(x.world!=c||x.dimension!=u)continue;let f=z(x.coordinates[1],x.coordinates[2]);for(let k of f)if(k.x==i.x&&k.z==i.z)return x}}_.getPlotFromBlock=O})(d||={});var S;(o=>{function t(n){n.worlds.on(E.WorldEvent.PlayerInteractWithBlock,e=>{if(e.itemStack?.type.identifier==C.ItemIdentifier.Stick)return G(e),!1;if(e.itemStack?.type.identifier==C.ItemIdentifier.GoldenShovel)return J(e),!1})}o.loadListeners=t})(S||={});var P={};function J(t){let o=t.player;if(L(o,1e3))return;let n=d.getPlotFromBlock(t.block.position,t.world.identifier,t.block.dimension.identifier);if(n){o.sendMessage("\xA7cFailed To Select Point, Point Overlays Claimed Plot."),d.labelPlot(n,o);return}let e=t.block.position;if(!P[o.username])o.sendMessage(`Selected Point 1 at: ${e.x},${e.y},${e.z}`),P[o.username]=e,setTimeout(()=>{P[o.username]&&(o.sendMessage("Plot Creation Canceled"),delete P[o.username])},1e4);else{let s=P[o.username],r=e;delete P[o.username],o.sendMessage(`Selected Point 1 at: ${e.x},${e.y},${e.z}`),o.sendMessage(`Selected Point 2 at: ${e.x},${e.y},${e.z}`)}}function G(t){let o=t.player;if(L(o,1e3))return;o.sendMessage("Used Stick");let n=d.getPlotFromBlock(t.block.position,t.world.identifier,t.block.dimension.identifier);n&&d.labelPlot(n,o),d.getPlotFromBlock(t.block.position,t.world.identifier,t.block.dimension.identifier)}var y={};function L(t,o){let n=y[t.username],e=Math.round(+new Date/1e3);return n?n<e?(delete y[t.username],!1):!0:(y[t.username]=e+o,!1)}var N=require("@serenityjs/world");var M=require("@serenityjs/protocol");function V(t,{logger:o}){S.loadListeners(t),o.info("Loading Plot Data"),d.loadDB(),t.worlds.on(N.WorldEvent.PlayerPlaceBlock,n=>{let e={coordinates:{1:new M.BlockCoordinates(10,0,10),2:new M.BlockCoordinates(0,0,0)},dimension:n.player.dimension.identifier,world:n.player.getWorld().identifier};d.addPlot(e)}),o.color("#329ba8"),o.log("Listeners Loaded")}function j(t,{logger:o}){o.info("Saved Plot Data"),d.unloadDB()}0&&(module.exports={onInitialize,onShutdown});
